<VirtualHost *:443>
    ServerName yopasshub.com
    ServerAlias www.yopasshub.com
    DocumentRoot /var/www/html/web_app_rdp/public

    # Configuration du dossier public principal
    <Directory /var/www/html/web_app_rdp/public>
        AllowOverride All
        Require all granted
        DirectoryIndex index.php
        Options -Indexes
        
        # Protection contre l'exécution de fichiers uploadés
        <FilesMatch "\.(php|phtml|php3|php4|php5|pl|py|jsp|asp|sh|cgi)$">
            <RequireAll>
                Require all denied
            </RequireAll>
        </FilesMatch>
        
        # Autoriser seulement index.php dans public
        <FilesMatch "^index\.php$">
            Require all granted
        </FilesMatch>
    </Directory>

    # Bloquer l'accès aux dossiers sensibles de Laravel
    <Directory /var/www/html/web_app_rdp/app>
        Require all denied
    </Directory>
    
    <Directory /var/www/html/web_app_rdp/bootstrap>
        Require all denied
    </Directory>
    
    <Directory /var/www/html/web_app_rdp/config>
        Require all denied
    </Directory>
    
    <Directory /var/www/html/web_app_rdp/database>
        Require all denied
    </Directory>
    
    <Directory /var/www/html/web_app_rdp/resources>
        Require all denied
    </Directory>
    
    <Directory /var/www/html/web_app_rdp/routes>
        Require all denied
    </Directory>
    
    <Directory /var/www/html/web_app_rdp/storage>
        Require all denied
    </Directory>
    
    <Directory /var/www/html/web_app_rdp/tests>
        Require all denied
    </Directory>
    
    <Directory /var/www/html/web_app_rdp/vendor>
        Require all denied
    </Directory>

    # Bloquer l'accès aux fichiers sensibles
    <Files ".env">
        Require all denied
    </Files>
    
    <Files ".env.*">
        Require all denied
    </Files>
    
    <Files "composer.json">
        Require all denied
    </Files>
    
    <Files "composer.lock">
        Require all denied
    </Files>
    
    <Files "package.json">
        Require all denied
    </Files>
    
    <Files "artisan">
        Require all denied
    </Files>
    
    <Files "*.log">
        Require all denied
    </Files>

    # Rediriger toutes les requêtes vers le dossier public si elles ne s'y trouvent pas déjà
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/public/
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule ^(.*)$ /public/$1 [L,R=301]

    # Configuration SSL (ajoutez vos certificats)
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    # SSLCertificateChainFile /path/to/your/chain.crt  # Si nécessaire

    # Headers de sécurité
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    ErrorLog /var/log/apache2/laravel-error.log
    CustomLog /var/log/apache2/laravel-access.log combined
</VirtualHost>

